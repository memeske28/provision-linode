---
- name: Orchestrate webserver setup
  hosts: webserver
  become: True
  vars:
    myuser: tboronczyk
    mydomain: novjorkio.org
  tasks:

    - name: Enable universe
      apt_repository:
        repo: "{{item}}"
      with_items:
        - deb http://archive.ubuntu.com/ubuntu {{ansible_lsb.codename}} universe
        - deb http://archive.ubuntu.com/ubuntu {{ansible_lsb.codename}}-security universe
        - deb http://archive.ubuntu.com/ubuntu {{ansible_lsb.codename}}-updates universe

    - name: Add certbot PPA repository
      apt_repository:
        repo: ppa:certbot/certbot

    - name: Install certbot
      apt:
        name: certbot

    - name: Install SSL/TLS certificates
      command: certbot certonly --standalone -n --agree-tos -m {{myuser}}@{{mydomain}} --rsa-key-size 4096 -d {{mydomain}},www.{{mydomain}},mail.{{mydomain}}

    - name: Add Oracle MySQL repository
      apt:
        deb: https://dev.mysql.com/get/mysql-apt-config_0.8.10-1_all.deb

    - name: Install MySQL
      apt:
        name: mysql-server

    - name: Configure MySQL
      template:
        src: files/etc/mysql/mysql.conf.d/mysqld.cnf
        dest: /etc/mysql/mysql.conf.d/mysqld.cnf
        owner: root
        group: root
        mode: 0644

    - name: Install Apache
      apt:
        name: apache2

    - name: Install PHP
      apt:
        name:
          - php
          - php-curl
          - php-intl
          - libapache2-mod-php

    - name: Install Composer
      apt:
        name: composer

    - name: Generate a new DH group
      command: openssl dhparam -out /etc/ssl/private/dhparams_4096.pem 4096
      args:
        creates: /etc/ssl/private/dhparams_4096.pem

    - name: Enable Apache modules
      apache2_module:
        name: "{{item}}"
      with_items:
        - headers
        - rewrite
        - ssl

    - name: Configure Apache
      template:
        src: "{{item.src}}"
        dest: "{{item.dest}}"
        owner: root
        group: root
        mode: 0644
      with_items:
        - {
            src: "files/etc/apache2/mods-available/ssl.conf",
            dest: "/etc/apache2/mods-available/ssl.conf"
          }
        - {
            src: "files/etc/apache2/sites-available/mydomain.conf",
            dest: "/etc/apache2/sites-available/{{mydomain}}.conf"
          }

    - name: Create web directory
      file:
        path: /var/www/{{mydomain}}/www/public
        state: directory

    - name: Set web directory ownership and permissions
      file:
        path: /var/www/{{mydomain}}
        owner: www-data
        group: www-data
        mode: u=rwX,g=rwX,o=rX
        recurse: yes

    - name: Set web directory group sticky bit
      file:
        path: /var/www/{{mydomain}}
        mode: g+s

    - name: Enable Apache site
      command: "{{item}}"
      with_items:
        - a2ensite {{mydomain}}
        - a2dissite 000-default

    - name: Create virtual mail user
      user:
        name: vmail
        comment: "virtual mail user"
        home: /var/spool/vmail
        shell: /usr/sbin/nologin
        system: yes

    - name: Install SQLite
      apt:
        name: sqlite3
 
    - name: Install Postfix
      apt:
        name:
         - postfix
         - postfix-sqlite

    - name: Install Dovecot
      apt:
        name:
         - dovecot-pop3d
         - dovecot-sqlite
         - dovecot-lmtpd

    - name: Install SpamAssassin
      apt:
        name:
          - spamassassin

    - name: Install OpenDKIM
      apt:
        name:
          - opendkim
          - opendkim-tools

    - name: Configure Postfix
      template:
        src: "{{item.src}}"
        dest: "{{item.dest}}"
        owner: root
        group: root
        mode: 0644
      with_items:
        - {
            src: "files/etc/postfix/main.cf",
            dest: "/etc/postfix/main.cf",
          }
        - {
            src: "files/etc/postfix/master.cf",
            dest: "/etc/postfix/master.cf",
          }
        - {
            src: "files/etc/postfix/sqlite-virtual-mailbox-domains.cf",
            dest: "/etc/postfix/sqlite-virtual-mailbox-domains.cf",
          }
        - {
            src: "files/etc/postfix/sqlite-virtual-mailbox-maps.cf",
            dest: "/etc/postfix/sqlite-virtual-mailbox-maps.cf",
          }
        - {
            src: "files/etc/postfix/sqlite-virtual-alias-maps.cf",
            dest: "/etc/postfix/sqlite-virtual-alias-maps.cf",
          }

    - name: Configure Dovecot
      template:
        src: "{{item.src}}"
        dest: "{{item.dest}}"
        owner: root
        group: root
        mode: 0644
      with_items:
        - {
            src: "files/etc/dovecot/conf.d/10-mail.conf",
            dest: "/etc/dovecot/conf.d/10-mail.conf"
          }
        - {
            src: "files/etc/dovecot/conf.d/10-auth.conf",
            dest: "/etc/dovecot/conf.d/10-auth.conf"
          }
        - {
            src: "files/etc/dovecot/conf.d/10-ssl.conf",
            dest: "/etc/dovecot/conf.d/10-ssl.conf"
          }
        - {
            src: "files/etc/dovecot/conf.d/10-master.conf",
            dest: "/etc/dovecot/conf.d/10-master.conf"
          }
        - {
            src: "files/etc/dovecot/dovecot-sql.conf.ext",
            dest: "/etc/dovecot/dovecot-sql.conf.ext"
          }
        - {
            src: "files/etc/dovecot/conf.d/auth-sql.conf.ext",
            dest: "/etc/dovecot/conf.d/auth-sql.conf.ext"
          }

    - name: Configure SpamAssassin
      template:
        src: "{{item.src}}"
        dest: "{{item.dest}}"
        owner: root
        group: root
        mode: 0644
      with_items:
        - {
            src: "files/etc/mail/spamassassin/local.cf",
            dest: "/etc/mail/spamassassin/local.cf",
          }
        - {
            src: "files/etc/default/spamassassin",
            dest: "/etc/default/spamassassin",
          }

#    - name: Update SpamAssassin database
#      command: sa-update

    - name: Configure OpenDKIM
      template:
        src: "{{item.src}}"
        dest: "{{item.dest}}"
        owner: root
        group: root
        mode: 0644
      with_items:
        - {
            src: "files/etc/opendkim.conf",
            dest: "/etc/opendkim.conf"
          }
        - {
            src: "files/etc/default/opendkim",
            dest: "/etc/default/opendkim"
          }
        - {
            src: "files/etc/opendkim/TrustedHosts",
            dest: "/etc/opendkim/TrustedHosts"
          }
        - {
            src: "files/etc/opendkim/KeyTable",
            dest: "/etc/opendkim/KeyTable"
          }
        - {
            src: "files/etc/opendkim/SigningTable",
            dest: "/etc/opendkim/SigningTable"
          }

    - name: Create OpenDKIM keys directory
      file:
        path: /etc/opendkim/keys/{{mydomain}}
        state: directory

    - name: Generate OpenDKIM Keys
      command: opendkim-genkey -s mail -d {{mydomain}}
      args:
        chdir: /etc/opendkim/keys/{{mydomain}}
        creates: /etc/opendkim/keys/{{mydomain}}/mail.private

    - name: Set OpenDKIM mail key ownership
      file:
        path: /etc/opendkim/keys/{{mydomain}}/mail.private
        owner: opendkim
        group: opendkim 

    - name: Configure primary mail account and aliases (upload SQL)
      template:
        src: files/accounts.sqlite.sql
        dest: /tmp/accounts.sqlite.sql

    - name: Configure primary mail account and aliases (import SQL)
      shell: sqlite3 /etc/postfix/accounts.sqlite < /tmp/accounts.sqlite.sql
      args:
        executable: /bin/bash
        creates: /etc/postfix/accounts.sqlite

    - name: Configure primary mail account and aliases (delete SQL)
      file:
        path: /tmp/accounts.sqlite.sql
        state: absent

    - name: Restart installed services
      systemd:
        enabled: yes
        state: restarted
        name: "{{item}}"
      with_items:
        - apache2
        - mysql
        - spamassassin
        - opendkim
        - postfix
        - dovecot

    - name: Update firewall rules
      ufw:
        rule: allow
        name: "{{item}}"
      with_items:
        - Apache Full
        - Postfix
        - Dovecot Secure POP3

