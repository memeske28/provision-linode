- name: Enable universe
  apt_repository:
    repo: "{{item}}"
    state: present
  with_items:
    - deb http://archive.ubuntu.com/ubuntu {{ansible_lsb.codename}} universe
    - deb http://archive.ubuntu.com/ubuntu {{ansible_lsb.codename}}-security universe
    - deb http://archive.ubuntu.com/ubuntu {{ansible_lsb.codename}}-updates universe

- name: Generate a new DH group file - THIS MAY TAKE A LONG TIME
  command: openssl dhparam -out /etc/ssl/private/dhparams_4096.pem 4096
  args:
    creates: /etc/ssl/private/dhparams_4096.pem

- name: Add certbot PPA repository
  apt_repository:
    repo: ppa:certbot/certbot
    state: present

- name: Install certbot
  apt:
    name: certbot
    state: present

- name: Install SSL/TLS certificates
  command: certbot certonly --standalone -n --agree-tos -m {{username}}@{{domain}} --rsa-key-size 4096 -d {{domain}},www.{{domain}},dev.{{domain}},mail.{{domain}}
  args:
    creates: /etc/letsencrypt/live/{{domain}}/

- name: Copy certificate renewal job
  copy:
    src: files/cron/renew-certificates
    dest: /etc/cron.weekly/renew-certificates
    owner: root
    group: root
    mode: 0755

- name: Install Apache
  apt:
    name: apache2
    state: present

- name: Install PHP
  apt:
    name:
      - php
      - php-curl
      - php-intl
      - php-pdo-mysql
      - php-simplexml
      - libapache2-mod-php
    state: present

- name: Install Composer
  apt:
    name:
      - zip
      - unzip
      - composer
    state: present

- name: Enable Apache modules
  apache2_module:
    name: "{{item}}"
    state: present
  with_items:
    - headers
    - rewrite
    - ssl

- name: Copy Apache site configuration template
  template:
    src: "templates/apache2/mydomain.conf.j2"
    dest: "/etc/apache2/sites-available/{{domain}}.conf"
    owner: root
    group: root
    mode: 0644

- name: Copy Apache SSL configuration file
  copy:
    src: "files/apache2/ssl.conf"
    dest: "/etc/apache2/mods-available/ssl.conf"
    owner: root
    group: root
    mode: 0644

- name: Create web directories
  file:
    path: "{{item}}"
    state: directory
  with_items:
    - /var/www/{{domain}}/www/public
    - /var/www/{{domain}}/dev/public

- name: Set web directories ownership and permissions
  file:
    path: "{{item.path}}"
    owner: www-data
    group: www-data
    mode: "{{item.mode}}"
    state: directory
  with_items:
    - { path: "/var/www/{{domain}}", mode: "u=rwX,g=rwXs,o=rX" }
    - { path: "/var/www/{{domain}}/www", mode: "u=rwX,g=rwX,o=rX" }
    - { path: "/var/www/{{domain}}/www/public", mode: "u=rwX,g=rwX,o=rX" }
    - { path: "/var/www/{{domain}}/dev", mode: "u=rwX,g=rwX,o=rX" }
    - { path: "/var/www/{{domain}}/dev/public", mode: "u=rwX,g=rwX,o=rX" }

- name: Disable Apache default site
  file:
    path: /etc/apache2/sites-enabled/000-default
    state: absent

- name: Enable Apache site
  file:
    src: /etc/apache2/sites-available/{{domain}}.conf
    dest: /etc/apache2/sites-enabled/{{domain}}.conf
    state: link

- name: Restart installed services
  systemd:
    name: apache2
    enabled: yes
    state: restarted

- name: Update firewall rules
  ufw:
    name: "{{item}}"
    rule: allow
    state: enabled
  with_items:
    - Apache Full
    - OpenSSH
